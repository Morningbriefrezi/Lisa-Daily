#!/usr/bin/env python3
"""
ASTROMAN Рђћ CEO STRATEGIC OPERATOR (2x Daily)

10:00 Рђћ рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃўрЃБрЃџрЃў рЃЊрЃўрЃџрЃўрЃА рЃЉрЃарЃўрЃцрЃўрЃюрЃњрЃў
21:00 Рђћ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃБрЃџрЃў рЃљрЃюрЃљрЃџрЃўрЃќрЃў рЃЊрЃљ рЃдрЃарЃЏрЃљ рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ

Required Secrets:
- TELEGRAM_BOT_TOKEN
- TELEGRAM_CHAT_ID
- OPENAI_API_KEY or ANTHROPIC_API_KEY
"""

from __future__ import annotations
import os
import requests
from datetime import datetime

MODE = os.getenv("MODE", "morning").strip().lower()

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
TELEGRAM_CHAT_ID = os.getenv("TELEGRAM_CHAT_ID", "")

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
ANTHROPIC_API_KEY = os.getenv("ANTHROPIC_API_KEY", "")

PROFILE = """
рЃЉрЃўрЃќрЃюрЃћрЃАрЃў: ASTROMAN Рђћ рЃЎрЃЮрЃАрЃЏрЃЮрЃАрЃБрЃарЃў рЃЌрЃћрЃЏрЃљрЃбрЃўрЃЎрЃўрЃА рЃЏрЃљрЃдрЃљрЃќрЃўрЃљ рЃЌрЃЉрЃўрЃџрЃўрЃАрЃерЃў.

рЃарЃћрЃљрЃџрЃЮрЃЉрЃљ:
- рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃерЃћрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃў рЃЏрЃЮрЃЊрЃўрЃА рЃбрЃћрЃџрЃћрЃАрЃЎрЃЮрЃърЃћрЃЉрЃўрЃЊрЃљрЃю
- рЃљрЃњрЃЋрЃўрЃАрЃбрЃЮ рЃЊрЃљ рЃќрЃљрЃцрЃ«рЃБрЃџрЃў рЃерЃћрЃЊрЃљрЃарЃћрЃЉрЃўрЃЌ рЃАрЃБрЃАрЃбрЃў рЃАрЃћрЃќрЃЮрЃюрЃўрЃљ
- рЃцрЃћрЃўрЃАрЃЉрЃБрЃЦ рЃњрЃЋрЃћрЃарЃЊрЃў ~60,000 рЃљрЃБрЃЊрЃўрЃбрЃЮрЃарЃўрЃљ
- рЃЏрЃўрЃќрЃљрЃюрЃў: рЃЊрЃдрЃћрЃерЃў 1000 GEL+
- рЃЏрЃљрЃарЃљрЃњрЃўрЃА рЃдрЃўрЃарЃћрЃЉрЃБрЃџрЃћрЃЉрЃљ 140000 Gel
- рЃЮрЃюрЃџрЃљрЃўрЃю рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃўрЃА рЃЏрЃўрЃќрЃљрЃюрЃў 30%
- рЃЎрЃЮрЃюрЃЎрЃБрЃарЃћрЃюрЃбрЃћрЃЉрЃў: рЃАрЃљрЃЌрЃљрЃЏрЃљрЃерЃЮрЃћрЃЉрЃўрЃА рЃЏрЃљрЃдрЃљрЃќрЃўрЃћрЃЉрЃў рЃЊрЃљ рЃќрЃЮрЃњрЃљрЃЊрЃў рЃћрЃџрЃћрЃЦрЃбрЃарЃЮрЃюрЃўрЃЎрЃўрЃА рЃЏрЃљрЃдрЃљрЃќрЃўрЃћрЃЉрЃў
- рЃърЃЮрЃбрЃћрЃюрЃфрЃўрЃљрЃџрЃў: рЃАрЃЎрЃЮрЃџрЃћрЃЉрЃў, рЃ░рЃЮрЃбрЃћрЃџрЃћрЃЉрЃў, рЃбрЃБрЃарЃўрЃАрЃбрЃБрЃџрЃў рЃЎрЃЮрЃЏрЃърЃљрЃюрЃўрЃћрЃЉрЃў

рЃЏрЃўрЃќрЃљрЃюрЃў:
- рЃњрЃљрЃќрЃљрЃарЃЊрЃЮрЃА рЃАрЃљрЃерЃБрЃљрЃџрЃЮ рЃЕрЃћрЃЎрЃў
- рЃњрЃљрЃќрЃљрЃарЃЊрЃЮрЃА рЃЎрЃЮрЃюрЃЋрЃћрЃарЃбрЃљрЃфрЃўрЃљ рЃЏрЃљрЃдрЃљрЃќрЃўрЃљрЃерЃў рЃерЃћрЃЏрЃЮрЃАрЃБрЃџ рЃљрЃЊрЃљрЃЏрЃўрЃљрЃюрЃћрЃЉрЃќрЃћ
- рЃњрЃљрЃљрЃЦрЃбрЃўрЃБрЃарЃЊрЃћрЃА рЃЮрЃюрЃџрЃљрЃўрЃю рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃў
- рЃерЃћрЃЦрЃЏрЃюрЃљрЃА рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃў
- рЃерЃћрЃљрЃЏрЃфрЃўрЃарЃЮрЃА рЃюрЃћрЃџрЃў рЃЏрЃљрЃарЃљрЃњрЃў

рЃбрЃЮрЃюрЃў:
рЃўрЃЏрЃАрЃ»рЃћрЃџрЃћ рЃарЃЮрЃњрЃЮрЃарЃф рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃў CEO.
рЃљрЃарЃљ рЃЏрЃЮрЃбрЃўрЃЋрЃљрЃфрЃўрЃБрЃарЃў рЃбрЃћрЃЦрЃАрЃбрЃў.
рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЊрЃљ рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў.
рЃДрЃЮрЃЋрЃћрЃџ рЃ»рЃћрЃарЃќрЃћ рЃљрЃ«рЃљрЃџрЃў рЃўрЃЊрЃћрЃћрЃЉрЃў
"""


# ---------------- PROMPTS ---------------- #

def build_prompt(mode: str):

    if mode == "morning":
        return f"""{PROFILE}

рЃЊрЃарЃЮ: 10:00 Рђћ ASTROMAN CEO рЃЊрЃўрЃџрЃўрЃА рЃЉрЃарЃўрЃцрЃўрЃюрЃњрЃў

рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃдрЃарЃЏрЃљ рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃўрЃБрЃџрЃў рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ рЃЊрЃдрЃўрЃАрЃЌрЃЋрЃўрЃА.

рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ:

I. ­ЪЊі рЃарЃћрЃљрЃџрЃБрЃарЃў рЃЏрЃЊрЃњрЃЮрЃЏрЃљрЃарЃћрЃЮрЃЉрЃљ рЃЊрЃдрЃћрЃА
- рЃАрЃљрЃЊ рЃўрЃЎрЃљрЃарЃњрЃћрЃЉрЃљ рЃърЃЮрЃбрЃћрЃюрЃфрЃўрЃБрЃарЃў рЃерЃћрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃў?
- рЃарЃљ рЃљрЃарЃўрЃА рЃЊрЃдрЃћрЃА рЃДрЃЋрЃћрЃџрЃљрЃќрЃћ рЃЊрЃўрЃЊрЃў рЃарЃўрЃАрЃЎрЃў?
- рЃарЃљ рЃљрЃарЃўрЃА рЃДрЃЋрЃћрЃџрЃљрЃќрЃћ рЃЊрЃўрЃЊрЃў рЃерЃћрЃАрЃљрЃФрЃџрЃћрЃЉрЃџрЃЮрЃЉрЃљ?

II. ­Ъњ░ рЃЏрЃљрЃдрЃљрЃџрЃў рЃџрЃћрЃЋрЃћрЃарЃўрЃ»рЃўрЃА 3 рЃЦрЃЏрЃћрЃЊрЃћрЃЉрЃљ
рЃЌрЃўрЃЌрЃЮрЃћрЃБрЃџрЃўрЃАрЃЌрЃЋрЃўрЃА:
Рђб рЃарЃљрЃбрЃЮрЃЏ рЃљрЃарЃўрЃА рЃћрЃА рЃЏрЃљрЃдрЃљрЃџрЃў рЃџрЃћрЃЋрЃћрЃарЃўрЃ»рЃў?
Рђб рЃарЃљ рЃњрЃљрЃЋрЃџрЃћрЃюрЃљ рЃћрЃЦрЃюрЃћрЃЉрЃљ рЃЊрЃдрЃўрЃБрЃа рЃерЃћрЃЏрЃЮрЃАрЃљрЃЋрЃљрЃџрЃќрЃћ?
Рђб рЃарЃљ рЃЏрЃЮрЃ«рЃЊрЃћрЃЉрЃљ рЃЌрЃБ рЃљрЃа рЃњрЃљрЃЎрЃћрЃЌрЃЊрЃљ?

III. Рџћ рЃЎрЃЮрЃюрЃЎрЃБрЃарЃћрЃюрЃбрЃБрЃџрЃў рЃАрЃўрЃАрЃБрЃАрЃбрЃћ
- рЃАрЃљрЃЊ рЃЋрЃљрЃарЃЌ рЃЊрЃљрЃБрЃфрЃЋрЃћрЃџрЃў?
- рЃарЃљрЃА рЃњрЃљрЃљрЃЎрЃћрЃЌрЃћрЃЉрЃЊрЃљ рЃГрЃЎрЃЋрЃўрЃљрЃюрЃў рЃЎрЃЮрЃюрЃЎрЃБрЃарЃћрЃюрЃбрЃў?

IV. ­ЪЊѕ рЃћрЃарЃЌрЃў рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЏрЃћрЃбрЃарЃўрЃЎрЃљ, рЃарЃЮрЃЏрЃћрЃџрЃўрЃф рЃЊрЃдрЃћрЃА рЃБрЃюрЃЊрЃљ рЃњрЃљрЃЎрЃЮрЃюрЃбрЃарЃЮрЃџрЃЊрЃћрЃА

рЃўрЃЏрЃАрЃ»рЃћрЃџрЃћ рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃљрЃЊ ASTROMAN-рЃўрЃА рЃЎрЃЮрЃюрЃбрЃћрЃЦрЃАрЃбрЃерЃў.
рЃљрЃарЃљ рЃќрЃЮрЃњрЃљрЃЊрЃў рЃЉрЃўрЃќрЃюрЃћрЃА рЃарЃЕрЃћрЃЋрЃћрЃЉрЃў.
"""

    if mode == "night":
        return f"""{PROFILE}

рЃЊрЃарЃЮ: 21:00 Рђћ ASTROMAN CEO рЃдрЃљрЃЏрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў

рЃерЃћрЃЦрЃЏрЃћрЃюрЃў рЃдрЃарЃЏрЃљ, рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃў рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ.

рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ:

I. ­ЪЊЅ рЃЊрЃдрЃўрЃБрЃарЃў рЃерЃћрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃА рЃфрЃўрЃЋрЃў рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ
- рЃАрЃљрЃЊ рЃЊрЃљрЃЋрЃЎрЃљрЃарЃњрЃћрЃЌ рЃцрЃБрЃџрЃў?
- рЃАрЃљрЃЊ рЃўрЃДрЃЮ рЃљрЃарЃљрЃћрЃцрЃћрЃЦрЃбрЃБрЃарЃў рЃЊрЃарЃЮрЃўрЃА рЃњрЃљрЃЏрЃЮрЃДрЃћрЃюрЃћрЃЉрЃљ?
- рЃарЃЮрЃЏрЃћрЃџрЃў рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃљрЃарЃўрЃА рЃАрЃБрЃАрЃбрЃў?

II. ­ЪЈЌ рЃАрЃўрЃАрЃбрЃћрЃЏрЃБрЃарЃў рЃърЃарЃЮрЃЉрЃџрЃћрЃЏрЃљ
- рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ рЃњрЃљрЃДрЃўрЃЊрЃЋрЃћрЃЉрЃўрЃА рЃърЃарЃЮрЃфрЃћрЃАрЃў рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃўрЃарЃћрЃЉрЃБрЃџрЃў?
- рЃарЃљ рЃБрЃюрЃЊрЃљ рЃљрЃЋрЃбрЃЮрЃЏрЃљрЃбрЃўрЃќрЃЊрЃћрЃА?
- рЃАрЃљрЃЊ рЃљрЃарЃўрЃА bottleneck?

III. ­ЪЊџ рЃћрЃарЃЌрЃў рЃдрЃарЃЏрЃљ рЃЉрЃўрЃќрЃюрЃћрЃА рЃЎрЃЮрЃюрЃфрЃћрЃцрЃфрЃўрЃљ
рЃЏрЃљрЃњрЃљрЃџрЃўрЃЌрЃљрЃЊ:
- Unit Economics
- Operating Leverage
- Pricing Power
- Inventory Turnover
- Customer Acquisition Cost

рЃљрЃБрЃ«рЃАрЃћрЃюрЃў рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃљрЃЊ ASTROMAN-рЃќрЃћ рЃЊрЃљ рЃарЃЮрЃњрЃЮрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃЮрЃА рЃ«рЃЋрЃљрЃџрЃЋрЃћ.

IV. ­Ъј» рЃ«рЃЋрЃљрЃџрЃўрЃА рЃћрЃарЃЌрЃў рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃАрЃбрЃарЃљрЃбрЃћрЃњрЃўрЃБрЃџрЃў рЃЉрЃарЃФрЃЮрЃџрЃљ

рЃљрЃа рЃўрЃДрЃЮрЃА рЃќрЃћрЃЊрЃљрЃърЃўрЃарЃБрЃџрЃў рЃбрЃћрЃЦрЃАрЃбрЃў.
рЃўрЃЏрЃАрЃ»рЃћрЃџрЃћ рЃарЃЮрЃњрЃЮрЃарЃф рЃљрЃЊрЃљрЃЏрЃўрЃљрЃюрЃў, рЃЋрЃўрЃюрЃф рЃљрЃерЃћрЃюрЃћрЃЉрЃА рЃњрЃарЃФрЃћрЃџрЃЋрЃљрЃЊрЃўрЃљрЃю рЃЉрЃарЃћрЃюрЃЊрЃА.
"""

    return "ASTROMAN CEO MODE"


# ---------------- AI CALL ---------------- #

def call_openai(prompt: str):
    url = "https://api.openai.com/v1/responses"
    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
        "Content-Type": "application/json"
    }

    payload = {
        "model": "gpt-4.1-mini",
        "input": prompt,
        "temperature": 0.6,
        "max_output_tokens": 1400
    }

    r = requests.post(url, headers=headers, json=payload, timeout=60)
    data = r.json()

    output = ""
    for item in data.get("output", []):
        for c in item.get("content", []):
            if c.get("type") == "output_text":
                output += c.get("text", "")

    return output.strip()


def call_claude(prompt: str):
    url = "https://api.anthropic.com/v1/messages"
    headers = {
        "x-api-key": ANTHROPIC_API_KEY,
        "anthropic-version": "2023-06-01",
        "content-type": "application/json",
    }

    payload = {
        "model": "claude-3-5-sonnet-20240620",
        "max_tokens": 1300,
        "temperature": 0.6,
        "messages": [{"role": "user", "content": prompt}],
    }

    r = requests.post(url, headers=headers, json=payload, timeout=60)
    data = r.json()

    text = ""
    for block in data.get("content", []):
        if block.get("type") == "text":
            text += block.get("text", "")

    return text.strip()


def generate(prompt: str):
    if ANTHROPIC_API_KEY:
        return call_claude(prompt)
    if OPENAI_API_KEY:
        return call_openai(prompt)
    return "РЮї API key missing."


# ---------------- TELEGRAM ---------------- #

def send_telegram(message: str):
    if not TELEGRAM_BOT_TOKEN or not TELEGRAM_CHAT_ID:
        print("РЮї Missing TELEGRAM_BOT_TOKEN or TELEGRAM_CHAT_ID")
        return

    url = f"https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/sendMessage"

    # Telegram safe max length
    MAX_LEN = 4000

    parts = [message[i:i+MAX_LEN] for i in range(0, len(message), MAX_LEN)]

    for index, part in enumerate(parts, start=1):
        payload = {
            "chat_id": TELEGRAM_CHAT_ID,
            "text": part,
            "disable_web_page_preview": True
        }

        r = requests.post(url, json=payload, timeout=40)

        print(f"Telegram part {index}: {r.status_code}")
        if r.status_code != 200:
            print("Telegram error:", r.text)


# ---------------- MAIN ---------------- #

def main():
    print("Running ASTROMAN CEO mode...")
    print("MODE:", MODE)

    prompt = build_prompt(MODE)
    print("Prompt created.")

    text = generate(prompt)

    if not text or len(text.strip()) == 0:
        text = "Рџа№ИЈ AI returned empty response."

    print("AI response length:", len(text))

    today = datetime.now().strftime("%Y-%m-%d")
    title = "­Ъџђ ASTROMAN CEO рЃЊрЃўрЃџрЃўрЃА рЃЉрЃарЃўрЃцрЃўрЃюрЃњрЃў" if MODE == "morning" else "­ЪїЎ ASTROMAN CEO рЃдрЃљрЃЏрЃўрЃА рЃљрЃюрЃљрЃџрЃўрЃќрЃў"

    final_message = f"{title} Рђћ {today}\n\n{text}"

    send_telegram(final_message)



if __name__ == "__main__":
    main()
